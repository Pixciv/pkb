name: Chaquopy Auto Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download Gradle from Google Drive
      run: |
        curl -L -o gradle-9.0.0-all.zip "https://drive.google.com/uc?export=download&id=1X9Oqt69tgekgddNvwHHvNSjxvRyVwi27"
        unzip -q gradle-9.0.0-all.zip -d gradle
        rm gradle-9.0.0-all.zip

    - name: Create minimal Android project
      run: |
        mkdir -p app/src/main/python
        printf "def main():\n    print('Hello Chaquopy!')\n" > app/src/main/python/hello.py
        printf "rootProject.name = \"ChaquopyHello\"\ninclude(\":app\")\n" > settings.gradle.kts
        printf "plugins {\n    id(\"com.android.application\")\n    id(\"com.chaquo.python\")\n}\n\nandroid {\n    compileSdk = 34\n    defaultConfig {\n        applicationId = \"org.example.chaquipyhello\"\n        minSdk = 21\n        targetSdk = 34\n        versionCode = 1\n        versionName = \"0.1.0\"\n    }\n}\n\npython {\n    buildPython = \"3.10\"\n}\n\nrepositories {\n    google()\n    mavenCentral()\n}\n" > build.gradle.kts

    - name: Setup Gradle Wrapper
      run: |
        ./gradle/bin/gradle wrapper --gradle-version 9.0.0
        chmod +x gradlew

    - name: Build APK
      run: |
        ./gradlew assembleDebug
        ls -lh app/build/outputs/apk/debug/

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChaquopyHello-debug-apk
        path: app/build/outputs/apk/debug/*.apk
