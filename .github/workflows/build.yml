name: Chaquopy Auto Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    # 1️⃣ Checkout
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Setup JDK 17
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    # 3️⃣ Setup Python 3.10
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 4️⃣ Download official Gradle
    - name: Download Gradle
      run: |
        curl -L -o gradle-9.0.0-all.zip https://services.gradle.org/distributions/gradle-9.0.0-all.zip
        unzip -q gradle-9.0.0-all.zip -d gradle
        rm gradle-9.0.0-all.zip
        export PATH="$PWD/gradle/gradle-9.0.0/bin:$PATH"

    # 5️⃣ Create minimal Chaquopy Android project
    - name: Create minimal Android project
      run: |
        mkdir -p app/src/main/python
        printf "def main():\n    print('Hello Chaquopy!')\n" > app/src/main/python/hello.py
        printf "rootProject.name = \"ChaquopyHello\"\ninclude(\":app\")\n" > settings.gradle.kts
        printf "plugins {\n    id(\"com.android.application\")\n    id(\"com.chaquo.python\")\n}\n\nandroid {\n    compileSdk = 34\n    defaultConfig {\n        applicationId = \"org.example.chaquipyhello\"\n        minSdk = 21\n        targetSdk = 34\n        versionCode = 1\n        versionName = \"0.1.0\"\n    }\n}\n\npython {\n    buildPython = \"3.10\"\n}\n\nrepositories {\n    google()\n    mavenCentral()\n}\n" > build.gradle.kts

    # 6️⃣ Setup Gradle wrapper
    - name: Setup Gradle Wrapper
      run: |
        ./gradle/gradle-9.0.0/bin/gradle wrapper --gradle-version 9.0.0
        chmod +x gradlew

    # 7️⃣ Build debug APK
    - name: Build APK
      run: |
        ./gradlew assembleDebug
        ls -lh app/build/outputs/apk/debug/

    # 8️⃣ Upload APK artifact
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChaquopyHello-debug-apk
        path: app/build/outputs/apk/debug/*.apk
