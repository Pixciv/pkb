name: Chaquopy Auto Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    # 1️⃣ Checkout
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Java kurulumu
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    # 3️⃣ Python kurulumu
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 4️⃣ Minimal Android Studio proje oluştur
    - name: Create minimal Android project
      run: |
        mkdir -p app/src/main/python
        # Python dosyası
        printf "def main():\n    print('Hello Chaquopy!')\n" > app/src/main/python/hello.py

        # settings.gradle.kts
        printf "rootProject.name = \"ChaquopyHello\"\ninclude(\":app\")\n" > settings.gradle.kts

        # build.gradle.kts
        printf "plugins {\n    id(\"com.android.application\")\n    id(\"com.chaquo.python\")\n}\n\nandroid {\n    compileSdk = 34\n    defaultConfig {\n        applicationId = \"org.example.chaquipyhello\"\n        minSdk = 21\n        targetSdk = 34\n        versionCode = 1\n        versionName = \"0.1.0\"\n    }\n}\n\npython {\n    buildPython = \"3.10\"\n}\n\nrepositories {\n    google()\n    mavenCentral()\n}\n" > build.gradle.kts

    # 5️⃣ Gradle wrapper oluştur ve APK build
    - name: Setup Gradle Wrapper and Build APK
      run: |
        # Gradle wrapper oluştur
        curl -sLO https://services.gradle.org/distributions/gradle-8.3-bin.zip
        unzip -q gradle-8.3-bin.zip -d gradle-8.3
        mkdir -p gradle/wrapper
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.3-bin.zip" > gradle/wrapper/gradle-wrapper.properties
        chmod +x gradlew || true

        # Gradle wrapper kullanarak build
        ./gradlew assembleDebug || ./gradle-8.3/bin/gradle assembleDebug
        ls -lh app/build/outputs/apk/debug/

    # 6️⃣ Artifact yükle
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChaquopyHello-debug-apk
        path: app/build/outputs/apk/debug/*.apk
